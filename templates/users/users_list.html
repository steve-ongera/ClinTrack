<!-- ========================================== -->
<!-- users/users_list.html -->
<!-- ========================================== -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Management - ClinTrack{% endblock %}

{% block extra_css %}
<style>
/* Apple-like typography */
body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Smaller font sizes */
h4 { font-size: 1.125rem; }
h5 { font-size: 1rem; }
p, td, li, th { font-size: 0.8125rem; }
small { font-size: 0.75rem; }

/* Clean breadcrumb */
.breadcrumb {
    background: transparent;
    padding: 0;
    margin-bottom: 0;
    font-size: 0.75rem;
}

.breadcrumb-item {
    color: #6c757d;
}

.breadcrumb-item a {
    color: #667eea;
    text-decoration: none;
    transition: color 0.2s ease;
}

.breadcrumb-item.active {
    color: #495057;
    font-weight: 500;
}

/* Page header */
.page-header {
    padding: 1rem 0;
    margin-bottom: 1.5rem;
}

.page-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #2a2a2a;
    margin-bottom: 0.25rem;
}

/* Card design */
.card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.card-body {
    padding: 1.25rem;
}

/* Card header with action buttons */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.25rem;
    padding-bottom: 0.875rem;
    border-bottom: 1px solid #f0f0f0;
}

.card-header h4 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #2a2a2a;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Button styling */
.btn {
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-sm {
    padding: 0.25rem 0.625rem;
    font-size: 0.6875rem;
    border-radius: 4px;
    min-width: 32px;
    height: 32px;
}

.btn-info {
    background: rgba(0, 167, 255, 0.1);
    color: #00a7ff;
    border: 1px solid rgba(0, 167, 255, 0.2);
}

.btn-info:hover {
    background: rgba(0, 167, 255, 0.2);
    transform: translateY(-1px);
}

.btn-warning {
    background: rgba(255, 171, 0, 0.1);
    color: #ffab00;
    border: 1px solid rgba(255, 171, 0, 0.2);
}

.btn-warning:hover {
    background: rgba(255, 171, 0, 0.2);
    transform: translateY(-1px);
}

.btn-danger {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.2);
}

.btn-danger:hover {
    background: rgba(220, 53, 69, 0.2);
    transform: translateY(-1px);
}

/* Stats cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #f0f0f0;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2a2a2a;
    margin-bottom: 0.25rem;
    line-height: 1;
}

.stat-label {
    font-size: 0.6875rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.stat-icon {
    color: #667eea;
    font-size: 0.875rem;
}

/* Table styling */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 6px;
    border: 1px solid #f0f0f0;
}

.table {
    margin-bottom: 0;
    font-size: 0.75rem;
    color: #495057;
    border-collapse: separate;
    border-spacing: 0;
}

.table thead th {
    border: none;
    background: #f8f9fa;
    font-weight: 600;
    color: #6c757d;
    padding: 0.75rem 1rem;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.table thead th:first-child {
    border-radius: 6px 0 0 0;
}

.table thead th:last-child {
    border-radius: 0 6px 0 0;
}

.table tbody td {
    padding: 0.75rem 1rem;
    vertical-align: middle;
    border-bottom: 1px solid #f0f0f0;
}

.table tbody tr:last-child td {
    border-bottom: none;
}

.table tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.03);
}

/* User avatar */
.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.75rem;
}

.user-cell {
    display: flex;
    align-items: center;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 500;
    color: #2a2a2a;
    margin-bottom: 0.125rem;
}

.user-username {
    font-size: 0.6875rem;
    color: #6c757d;
}

/* Role badges */
.role-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.6875rem;
    letter-spacing: 0.3px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.role-admin { background: rgba(220, 53, 69, 0.1); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.2); }
.role-coordinator { background: rgba(255, 171, 0, 0.1); color: #ffab00; border: 1px solid rgba(255, 171, 0, 0.2); }
.role-researcher { background: rgba(0, 167, 255, 0.1); color: #00a7ff; border: 1px solid rgba(0, 167, 255, 0.2); }
.role-viewer { background: rgba(108, 117, 125, 0.1); color: #6c757d; border: 1px solid rgba(108, 117, 125, 0.2); }

/* Status badges */
.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.6875rem;
    letter-spacing: 0.3px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.badge-success {
    background: rgba(40, 199, 111, 0.1);
    color: #28c76f;
    border: 1px solid rgba(40, 199, 111, 0.2);
}

.badge-secondary {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
    border: 1px solid rgba(108, 117, 125, 0.2);
}

/* Email cell */
.email-cell {
    font-size: 0.75rem;
    color: #495057;
    word-break: break-word;
}

/* Action buttons */
.action-buttons {
    display: flex;
    gap: 0.25rem;
    flex-wrap: nowrap;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 2.5rem;
    color: #e0e0e0;
    margin-bottom: 1rem;
    display: block;
}

.empty-state h5 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

.empty-state p {
    font-size: 0.75rem;
    margin-bottom: 1.5rem;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
}

/* Filter bar */
.filter-bar {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.25rem;
    border: 1px solid #f0f0f0;
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.filter-header h6 {
    font-size: 0.75rem;
    font-weight: 600;
    color: #495057;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}

.filter-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.filter-select {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: white;
    color: #495057;
    min-width: 120px;
}

.filter-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-select {
        width: 100%;
    }
    
    .table thead th,
    .table tbody td {
        padding: 0.5rem;
        font-size: 0.6875rem;
    }
    
    .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.6875rem;
    }
    
    .page-title {
        font-size: 1rem;
    }
    
    /* Hide less important columns on mobile */
    .table td:nth-child(4), /* Role */
    .table th:nth-child(4),
    .table td:nth-child(5), /* Phone */
    .table th:nth-child(5),
    .table td:nth-child(7), /* Created */
    .table th:nth-child(7) {
        display: none;
    }
}

@media (max-width: 576px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .btn-sm {
        min-width: 0;
        justify-content: center;
    }
    
    .empty-state {
        padding: 1.5rem 1rem;
    }
}

/* Focus states for accessibility */
.form-control:focus,
.btn:focus,
.filter-select:focus {
    outline: 2px solid rgba(102, 126, 234, 0.5);
    outline-offset: 2px;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .card {
        background: #2d2d2d;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }
    
    .page-title,
    .card-header h4,
    .user-name {
        color: #ffffff;
    }
    
    .card-header {
        border-bottom-color: #404040;
    }
    
    .stat-card {
        background: #3d3d3d;
        border-color: #404040;
    }
    
    .stat-value {
        color: #ffffff;
    }
    
    .stat-label {
        color: #b0b0b0;
    }
    
    .table {
        color: #e0e0e0;
        border-color: #404040;
    }
    
    .table thead th {
        background: #3d3d3d;
        color: #b0b0b0;
    }
    
    .table tbody td {
        border-bottom-color: #404040;
    }
    
    .table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .filter-bar {
        background: #3d3d3d;
        border-color: #404040;
    }
    
    .filter-header h6 {
        color: #e0e0e0;
    }
    
    .filter-select {
        background: #4d4d4d;
        border-color: #505050;
        color: #e0e0e0;
    }
    
    .empty-state i {
        color: #505050;
    }
    
    .empty-state h5 {
        color: #e0e0e0;
    }
    
    .user-username,
    .email-cell {
        color: #b0b0b0;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="page-header">
    <h3 class="page-title">Staff Management</h3>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Staff</li>
      </ol>
    </nav>
  </div>

  <div class="row">
    <div class="col-12">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">{{ total_users }}</div>
          <div class="stat-label">
            <i class="bi bi-people stat-icon"></i>
            Total Staff
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">{{ active_users }}</div>
          <div class="stat-label">
            <i class="bi bi-check-circle stat-icon"></i>
            Active
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">{{ admin_count }}</div>
          <div class="stat-label">
            <i class="bi bi-shield-check stat-icon"></i>
            Administrators
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">{{ researcher_count }}</div>
          <div class="stat-label">
            <i class="bi bi-flask stat-icon"></i>
            Researchers
          </div>
        </div>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <div class="filter-header">
          <h6>Filter Staff</h6>
          <div class="filter-controls">
            <select class="filter-select" id="roleFilter">
              <option value="">All Roles</option>
              <option value="admin">Administrator</option>
              <option value="coordinator">Coordinator</option>
              <option value="researcher">Researcher</option>
              <option value="viewer">Viewer</option>
            </select>
            
            <select class="filter-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
            
            <input type="text" 
                   class="filter-select" 
                   id="searchFilter" 
                   placeholder="Search names or emails...">
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="card-header">
            <h4>
              <i class="bi bi-people"></i>
              All Staff Members
              <span class="badge bg-light text-dark ms-2" style="font-size: 0.75rem;">
                {{ users|length }}
              </span>
            </h4>
            <a href="{% url 'users_create' %}" class="btn btn-primary">
              <i class="bi bi-person-plus"></i>
              Add Staff
            </a>
          </div>

          {% if users %}
          <div class="table-responsive">
            <table class="table" id="staffTable">
              <thead>
                <tr>
                  <th>Staff Member</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr data-role="{{ user.role }}" data-status="{% if user.is_active %}active{% else %}inactive{% endif %}" 
                    data-search="{{ user.username|lower }} {{ user.get_full_name|lower|default:'' }} {{ user.email|lower|default:'' }}">
                  <!-- User Column -->
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar">
                        {{ user.get_full_name|default:user.username|slice:":1"|upper }}
                      </div>
                      <div class="user-info">
                        <div class="user-name">
                          {{ user.get_full_name|default:"No Name" }}
                        </div>
                        <div class="user-username">
                          @{{ user.username }}
                        </div>
                      </div>
                    </div>
                  </td>
                  
                  <!-- Email -->
                  <td class="email-cell">
                    {% if user.email %}
                    <a href="mailto:{{ user.email }}" class="text-decoration-none">
                      {{ user.email|truncatechars:25 }}
                    </a>
                    {% else %}
                    <span class="text-muted">No email</span>
                    {% endif %}
                  </td>
                  
                  <!-- Role -->
                  <td>
                    <span class="role-badge role-{{ user.role }}">
                      <i class="bi bi-{% if user.role == 'admin' %}shield-check{% elif user.role == 'coordinator' %}clipboard-data{% elif user.role == 'researcher' %}flask{% else %}eye{% endif %}"></i>
                      {{ user.get_role_display }}
                    </span>
                  </td>
                  
                  <!-- Phone -->
                  <td>
                    {% if user.phone_number %}
                    <a href="tel:{{ user.phone_number }}" class="text-decoration-none">
                      {{ user.phone_number }}
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  
                  <!-- Status -->
                  <td>
                    {% if user.is_active %}
                    <span class="badge badge-success">
                      <i class="bi bi-check-circle"></i>
                      Active
                    </span>
                    {% else %}
                    <span class="badge badge-secondary">
                      <i class="bi bi-x-circle"></i>
                      Inactive
                    </span>
                    {% endif %}
                  </td>
                  
                  <!-- Created -->
                  <td>
                    <small class="text-muted">
                      {{ user.created_at|date:"M d, Y" }}
                    </small>
                  </td>
                  
                  <!-- Actions -->
                  <td>
                    <div class="action-buttons">
                      <a href="{% url 'users_profile' %}?user={{ user.id }}" class="btn btn-sm btn-info" title="View Profile">
                        <i class="bi bi-eye"></i>
                      </a>
                      {% if request.user.role == 'admin' and request.user != user %}
                      <a href="#" class="btn btn-sm btn-warning" title="Edit User">
                        <i class="bi bi-pencil"></i>
                      </a>
                      {% if user.is_active %}
                      <button class="btn btn-sm btn-danger" onclick="toggleUserStatus({{ user.id }}, false)" title="Deactivate">
                        <i class="bi bi-person-x"></i>
                      </button>
                      {% else %}
                      <button class="btn btn-sm btn-success" onclick="toggleUserStatus({{ user.id }}, true)" title="Activate">
                        <i class="bi bi-person-check"></i>
                      </button>
                      {% endif %}
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Table footer -->
          <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
            <small class="text-muted">
              Showing {{ users|length }} staff member{{ users|length|pluralize }}
            </small>
            <div>
              <button class="btn btn-sm btn-outline-secondary" onclick="exportStaffList()">
                <i class="bi bi-download"></i>
                Export List
              </button>
            </div>
          </div>
          
          {% else %}
          <div class="empty-state">
            <i class="bi bi-person-x"></i>
            <h5>No Staff Members Found</h5>
            <p>No staff members have been added to the system yet.</p>
            <a href="{% url 'users_create' %}" class="btn btn-primary">
              <i class="bi bi-person-plus"></i>
              Add First Staff Member
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const searchFilter = document.getElementById('searchFilter');
    const tableRows = document.querySelectorAll('#staffTable tbody tr');
    
    function filterTable() {
        const roleValue = roleFilter.value;
        const statusValue = statusFilter.value;
        const searchValue = searchFilter.value.toLowerCase();
        
        tableRows.forEach(row => {
            let show = true;
            
            // Filter by role
            if (roleValue && row.dataset.role !== roleValue) {
                show = false;
            }
            
            // Filter by status
            if (statusValue && row.dataset.status !== statusValue) {
                show = false;
            }
            
            // Filter by search
            if (searchValue && !row.dataset.search.includes(searchValue)) {
                show = false;
            }
            
            row.style.display = show ? '' : 'none';
        });
    }
    
    // Add event listeners for filters
    roleFilter.addEventListener('change', filterTable);
    statusFilter.addEventListener('change', filterTable);
    searchFilter.addEventListener('input', filterTable);
    
    // User status toggle function
    window.toggleUserStatus = function(userId, activate) {
        const action = activate ? 'activate' : 'deactivate';
        const confirmation = confirm(`Are you sure you want to ${action} this user?`);
        
        if (confirmation) {
            // In a real application, this would be an AJAX call
            // For now, we'll show a message
            alert(`User ${action}d successfully. This would be an API call in production.`);
            
            // Refresh the page to show updated status
            // In production, you would update the UI without refresh
            window.location.reload();
        }
    };
    
    // Export functionality
    window.exportStaffList = function() {
        // In a real application, this would trigger a CSV download
        // For now, we'll show a message
        alert('Exporting staff list to CSV... This would download a file in production.');
        
        // Simulate download
        const data = [
            ['Name', 'Username', 'Email', 'Role', 'Phone', 'Status', 'Created'],
            ...Array.from(tableRows).map(row => {
                const cells = row.querySelectorAll('td');
                return [
                    row.querySelector('.user-name').textContent.trim(),
                    row.querySelector('.user-username').textContent.trim().replace('@', ''),
                    cells[1].textContent.trim(),
                    cells[2].textContent.trim(),
                    cells[3].textContent.trim(),
                    cells[4].textContent.trim(),
                    cells[5].textContent.trim()
                ];
            })
        ];
        
        // Convert to CSV
        const csvContent = data.map(row => 
            row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')
        ).join('\n');
        
        // Create download link (in production, this would be server-side)
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `staff-list-${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };
    
    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[title]');
    tooltipTriggerList.forEach(tooltipTriggerEl => {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}