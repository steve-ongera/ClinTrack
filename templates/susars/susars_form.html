<!-- ========================================== -->
<!-- 3. susars/susars_form.html -->
<!-- ========================================== -->
{% extends 'base.html' %}
{% load static %}

{% block title %}{% if susar %}Edit{% else %}Report{% endif %} SUSAR - ClinTrack{% endblock %}

{% block extra_css %}
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

h4 { font-size: 1.125rem; }
p, label { font-size: 0.8125rem; }
small { font-size: 0.75rem; }

.breadcrumb {
    background: transparent;
    padding: 0;
    margin-bottom: 0;
    font-size: 0.75rem;
}

.breadcrumb-item { color: #6c757d; }
.breadcrumb-item a { color: #667eea; text-decoration: none; }
.breadcrumb-item.active { color: #495057; font-weight: 500; }

.page-header {
    padding: 1rem 0;
    margin-bottom: 1.5rem;
}

.page-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #2a2a2a;
}

.card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    margin-bottom: 1.5rem;
}

.card-body { padding: 1.25rem; }

.card-header {
    margin-bottom: 1.25rem;
    padding-bottom: 0.875rem;
    border-bottom: 1px solid #f0f0f0;
}

.card-header h4 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #2a2a2a;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-section {
    margin-bottom: 2rem;
}

.form-section:last-child { margin-bottom: 0; }

.section-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #2a2a2a;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label {
    font-size: 0.75rem;
    color: #495057;
    font-weight: 500;
    margin-bottom: 0.375rem;
}

.form-label.required::after {
    content: " *";
    color: #dc3545;
}

.form-control, .form-select, textarea {
    font-size: 0.8125rem;
    padding: 0.625rem 0.875rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus, textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

textarea.form-control {
    min-height: 100px;
    resize: vertical;
}

.form-check {
    padding-left: 1.75rem;
    margin-bottom: 0.75rem;
}

.form-check-input {
    width: 1.125rem;
    height: 1.125rem;
    margin-top: 0.125rem;
    cursor: pointer;
}

.form-check-label {
    font-size: 0.8125rem;
    color: #495057;
    cursor: pointer;
    margin-left: 0.5rem;
}

.form-text {
    font-size: 0.6875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.btn {
    border-radius: 6px;
    padding: 0.625rem 1.25rem;
    font-size: 0.8125rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

.form-actions {
    display: flex;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f0f0f0;
    margin-top: 2rem;
}

.alert {
    border-radius: 6px;
    padding: 0.875rem 1.125rem;
    font-size: 0.8125rem;
    margin-bottom: 1.5rem;
    border: none;
}

.alert-danger {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border-left: 3px solid #dc3545;
}

.errorlist {
    list-style: none;
    padding: 0;
    margin: 0.375rem 0 0 0;
}

.errorlist li {
    color: #dc3545;
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.is-invalid {
    border-color: #dc3545;
}

.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="page-header">
    <h3 class="page-title">{% if susar %}Edit SUSAR{% else %}Report New SUSAR{% endif %}</h3>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'susars_list' %}">SUSARs</a></li>
        <li class="breadcrumb-item active">{% if susar %}Edit{% else %}New{% endif %}</li>
      </ol>
    </nav>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card">
        <div class="card-body">
          <div class="card-header">
            <h4>
              <i class="bi bi-exclamation-triangle"></i>
              SUSAR Report Form
            </h4>
          </div>

          {% if form.errors %}
          <div class="alert alert-danger">
            <strong>Please correct the errors below:</strong>
            <ul class="errorlist">
              {% for field, errors in form.errors.items %}
                {% for error in errors %}
                  <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          <form method="post">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="form-section">
              <div class="section-title">
                <i class="bi bi-info-circle"></i>
                Basic Information
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ form.susar_id.id_for_label }}" class="form-label required">SUSAR ID</label>
                  {{ form.susar_id }}
                  {% if form.susar_id.errors %}
                    <ul class="errorlist">{% for error in form.susar_id.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                  {% endif %}
                  <small class="form-text">Unique identifier for this SUSAR report</small>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="{{ form.participant.id_for_label }}" class="form-label required">Participant</label>
                  {{ form.participant }}
                  {% if form.participant.errors %}
                    <ul class="errorlist">{% for error in form.participant.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Event Details -->
            <div class="form-section">
              <div class="section-title">
                <i class="bi bi-clipboard-data"></i>
                Event Details
              </div>
              
              <div class="mb-3">
                <label for="{{ form.event_description.id_for_label }}" class="form-label required">Event Description</label>
                {{ form.event_description }}
                {% if form.event_description.errors %}
                  <ul class="errorlist">{% for error in form.event_description.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}
                <small class="form-text">Provide detailed description of the adverse event</small>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ form.onset_date.id_for_label }}" class="form-label required">Onset Date & Time</label>
                  {{ form.onset_date }}
                  {% if form.onset_date.errors %}
                    <ul class="errorlist">{% for error in form.onset_date.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                  {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="{{ form.detection_date.id_for_label }}" class="form-label required">Detection Date & Time</label>
                  {{ form.detection_date }}
                  {% if form.detection_date.errors %}
                    <ul class="errorlist">{% for error in form.detection_date.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                  {% endif %}
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ form.severity.id_for_label }}" class="form-label required">Severity</label>
                  {{ form.severity }}
                  {% if form.severity.errors %}
                    <ul class="errorlist">{% for error in form.severity.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                  {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="{{ form.outcome.id_for_label }}" class="form-label required">Outcome</label>
                  {{ form.outcome }}
                  {% if form.outcome.errors %}
                    <ul class="errorlist">{% for error in form.outcome.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Causality Assessment -->
            <div class="form-section">
              <div class="section-title">
                <i class="bi bi-diagram-3"></i>
                Causality Assessment
              </div>
              
              <div class="mb-3">
                <div class="form-check">
                  {{ form.is_related_to_study }}
                  <label class="form-check-label" for="{{ form.is_related_to_study.id_for_label }}">
                    Event is related to study intervention
                  </label>
                </div>
              </div>

              <div class="mb-3">
                <label for="{{ form.causality_assessment.id_for_label }}" class="form-label">Causality Assessment Details</label>
                {{ form.causality_assessment }}
                {% if form.causality_assessment.errors %}
                  <ul class="errorlist">{% for error in form.causality_assessment.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}
              </div>

              <div class="mb-3">
                <div class="form-check">
                  {{ form.hospitalization_required }}
                  <label class="form-check-label" for="{{ form.hospitalization_required.id_for_label }}">
                    Hospitalization required
                  </label>
                </div>
              </div>
            </div>

            <!-- Actions Taken -->
            <div class="form-section">
              <div class="section-title">
                <i class="bi bi-clipboard-check"></i>
                Actions & Interventions
              </div>
              
              <div class="mb-3">
                <label for="{{ form.actions_taken.id_for_label }}" class="form-label required">Actions Taken</label>
                {{ form.actions_taken }}
                {% if form.actions_taken.errors %}
                  <ul class="errorlist">{% for error in form.actions_taken.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}
                <small class="form-text">Describe all actions taken in response to this event</small>
              </div>
            </div>

            <!-- Reporting -->
            <div class="form-section">
              <div class="section-title">
                <i class="bi bi-file-earmark-text"></i>
                Regulatory Reporting
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    {{ form.reported_to_irb }}
                    <label class="form-check-label" for="{{ form.reported_to_irb.id_for_label }}">
                      Reported to IRB/Ethics Committee
                    </label>
                  </div>
                  
                  <div class="mt-2">
                    <label for="{{ form.irb_report_date.id_for_label }}" class="form-label">IRB Report Date</label>
                    {{ form.irb_report_date }}
                    {% if form.irb_report_date.errors %}
                      <ul class="errorlist">{% for error in form.irb_report_date.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    {{ form.reported_to_sponsor }}
                    <label class="form-check-label" for="{{ form.reported_to_sponsor.id_for_label }}">
                      Reported to Sponsor
                    </label>
                  </div>
                  
                  <div class="mt-2">
                    <label for="{{ form.sponsor_report_date.id_for_label }}" class="form-label">Sponsor Report Date</label>
                    {{ form.sponsor_report_date }}
                    {% if form.sponsor_report_date.errors %}
                      <ul class="errorlist">{% for error in form.sponsor_report_date.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Follow-up -->
            <div class="form-section">
              <div class="section-title">
                <i class="bi bi-arrow-repeat"></i>
                Follow-up
              </div>
              
              <div class="mb-3">
                <div class="form-check">
                  {{ form.follow_up_required }}
                  <label class="form-check-label" for="{{ form.follow_up_required.id_for_label }}">
                    Follow-up required
                  </label>
                </div>
              </div>

              <div class="mb-3">
                <label for="{{ form.follow_up_notes.id_for_label }}" class="form-label">Follow-up Notes</label>
                {{ form.follow_up_notes }}
                {% if form.follow_up_notes.errors %}
                  <ul class="errorlist">{% for error in form.follow_up_notes.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i>
                {% if susar %}Update SUSAR{% else %}Submit SUSAR Report{% endif %}
              </button>
              <a href="{% url 'susars_list' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i>
                Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script>
// Auto-populate detection date with current datetime if empty
document.addEventListener('DOMContentLoaded', function() {
    const detectionDateInput = document.getElementById('{{ form.detection_date.id_for_label }}');
    if (detectionDateInput && !detectionDateInput.value) {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
        detectionDateInput.value = localISOTime;
    }
});
</script>
{% endblock %}

