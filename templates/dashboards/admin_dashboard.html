{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - ClinTrack{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 24px;
        background-color: #f7fafc;
        min-height: 100vh;
    }
    
    .dashboard-header {
        margin-bottom: 32px;
    }
    
    .dashboard-title {
        font-size: 32px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 8px;
    }
    
    .dashboard-subtitle {
        color: #718096;
        font-size: 16px;
    }
    
    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    .stat-icon.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .stat-icon.success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
    }
    
    .stat-icon.warning {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
    }
    
    .stat-icon.danger {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        color: white;
    }
    
    .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4px;
    }
    
    .stat-label {
        color: #718096;
        font-size: 14px;
        font-weight: 500;
    }
    
    .stat-change {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px;
    }
    
    .stat-change.positive {
        background: #c6f6d5;
        color: #276749;
    }
    
    .stat-change.negative {
        background: #fed7d7;
        color: #c53030;
    }
    
    /* Charts Section */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .chart-header {
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
    }
    
    .chart-container {
        height: 300px;
    }
    
    /* Tables */
    .table-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }
    
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .table-title {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th {
        background: #f7fafc;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #4a5568;
        font-size: 14px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        color: #2d3748;
        font-size: 14px;
    }
    
    .data-table tr:hover {
        background: #f7fafc;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-success {
        background: #c6f6d5;
        color: #276749;
    }
    
    .badge-warning {
        background: #feebc8;
        color: #c05621;
    }
    
    .badge-danger {
        background: #fed7d7;
        color: #c53030;
    }
    
    .badge-info {
        background: #bee3f8;
        color: #2c5282;
    }
    
    .badge-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">üë®‚Äçüíº Administrator Dashboard</h1>
        <p class="dashboard-subtitle">Welcome back, {{ user.first_name|default:user.username }}! Here's your system overview.</p>
    </div>
    
    <!-- Key Metrics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ total_participants }}</div>
                    <div class="stat-label">Total Participants</div>
                    <span class="stat-change positive">+{{ recent_participants }} this month</span>
                </div>
                <div class="stat-icon primary">üë•</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ active_participants }}</div>
                    <div class="stat-label">Active Participants</div>
                    <span class="stat-change positive">{{ active_participants|floatformat:0 }}% active rate</span>
                </div>
                <div class="stat-icon success">‚úÖ</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ total_susars }}</div>
                    <div class="stat-label">Total SUSARs</div>
                    <span class="stat-change {% if critical_susars > 0 %}negative{% else %}positive{% endif %}">{{ critical_susars }} critical</span>
                </div>
                <div class="stat-icon warning">‚ö†Ô∏è</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ total_studies }}</div>
                    <div class="stat-label">Active Studies</div>
                    <span class="stat-change positive">All operational</span>
                </div>
                <div class="stat-icon danger">üìö</div>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-grid">
        <!-- Enrollment Trends -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìà Enrollment Trends (12 Months)</h3>
            </div>
            <div class="chart-container">
                <canvas id="enrollmentChart"></canvas>
            </div>
        </div>
        
        <!-- SUSAR Trends -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">‚ö†Ô∏è SUSAR Trends (12 Months)</h3>
            </div>
            <div class="chart-container">
                <canvas id="susarChart"></canvas>
            </div>
        </div>
        
        <!-- Status Distribution -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìä Participant Status Distribution</h3>
            </div>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        
        <!-- SUSAR Severity -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üéØ SUSAR Severity Breakdown</h3>
            </div>
            <div class="chart-container">
                <canvas id="severityChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Study Breakdown Table -->
    <div class="table-card">
        <div class="table-header">
            <h3 class="table-title">üìö Study Overview</h3>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Study Name</th>
                    <th>Code</th>
                    <th>Total Participants</th>
                    <th>Active</th>
                    <th>SUSARs</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for study in study_breakdown %}
                <tr>
                    <td><strong>{{ study.name }}</strong></td>
                    <td><span class="badge badge-info">{{ study.code }}</span></td>
                    <td>{{ study.participant_count }}</td>
                    <td>{{ study.active_count }}</td>
                    <td>{{ study.susar_count }}</td>
                    <td>
                        {% if study.is_active %}
                            <span class="badge badge-success">Active</span>
                        {% else %}
                            <span class="badge badge-secondary">Inactive</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Recent Participants -->
    <div class="table-card">
        <div class="table-header">
            <h3 class="table-title">üÜï Recent Participants</h3>
            <button class="btn btn-primary">View All</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Participant ID</th>
                    <th>Name</th>
                    <th>Study</th>
                    <th>Status</th>
                    <th>Location</th>
                    <th>Added</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in recent_participants_list %}
                <tr>
                    <td><strong>{{ participant.participant_id }}</strong></td>
                    <td>{{ participant.first_name }} {{ participant.last_name }}</td>
                    <td><span class="badge badge-info">{{ participant.study.code }}</span></td>
                    <td>
                        {% if participant.status == 'active' %}
                            <span class="badge badge-success">Active</span>
                        {% elif participant.status == 'screening' %}
                            <span class="badge badge-warning">Screening</span>
                        {% elif participant.status == 'completed' %}
                            <span class="badge badge-info">Completed</span>
                        {% else %}
                            <span class="badge badge-secondary">{{ participant.status|title }}</span>
                        {% endif %}
                    </td>
                    <td>{{ participant.location }}</td>
                    <td>{{ participant.created_at|date:"M d, Y" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Recent SUSARs -->
    <div class="table-card">
        <div class="table-header">
            <h3 class="table-title">‚ö†Ô∏è Recent SUSARs</h3>
            <button class="btn btn-primary">View All</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>SUSAR ID</th>
                    <th>Participant</th>
                    <th>Severity</th>
                    <th>Outcome</th>
                    <th>Onset Date</th>
                    <th>Reported</th>
                </tr>
            </thead>
            <tbody>
                {% for susar in recent_susars_list %}
                <tr>
                    <td><strong>{{ susar.susar_id }}</strong></td>
                    <td>{{ susar.participant.participant_id }}</td>
                    <td>
                        {% if susar.severity == 'severe' or susar.severity == 'life_threatening' or susar.severity == 'fatal' %}
                            <span class="badge badge-danger">{{ susar.get_severity_display }}</span>
                        {% elif susar.severity == 'moderate' %}
                            <span class="badge badge-warning">{{ susar.get_severity_display }}</span>
                        {% else %}
                            <span class="badge badge-success">{{ susar.get_severity_display }}</span>
                        {% endif %}
                    </td>
                    <td>{{ susar.get_outcome_display }}</td>
                    <td>{{ susar.onset_date|date:"M d, Y" }}</td>
                    <td>
                        {% if susar.reported_to_irb %}
                            <span class="badge badge-success">IRB ‚úì</span>
                        {% else %}
                            <span class="badge badge-warning">Pending</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Chart.js Configuration
    const chartColors = {
        primary: '#667eea',
        success: '#48bb78',
        warning: '#ed8936',
        danger: '#f56565',
        info: '#4299e1',
    };
    
    // Enrollment Trends Chart
    const enrollmentCtx = document.getElementById('enrollmentChart').getContext('2d');
    new Chart(enrollmentCtx, {
        type: 'line',
        data: {
            labels: [{% for item in enrollment_trends %}'{{ item.month|date:"M Y" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Enrollments',
                data: [{% for item in enrollment_trends %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: chartColors.primary,
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
    
    // SUSAR Trends Chart
    const susarCtx = document.getElementById('susarChart').getContext('2d');
    new Chart(susarCtx, {
        type: 'line',
        data: {
            labels: [{% for item in susar_trends %}'{{ item.month|date:"M Y" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'SUSARs',
                data: [{% for item in susar_trends %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: chartColors.warning,
                backgroundColor: 'rgba(237, 137, 54, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
    
    // Status Distribution Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for item in status_breakdown %}'{{ item.status|title }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in status_breakdown %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: [
                    chartColors.success,
                    chartColors.info,
                    chartColors.warning,
                    chartColors.danger,
                    chartColors.primary
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // SUSAR Severity Chart
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    new Chart(severityCtx, {
        type: 'bar',
        data: {
            labels: [{% for item in susar_severity %}'{{ item.severity|title }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Count',
                data: [{% for item in susar_severity %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: [chartColors.success, chartColors.warning, chartColors.danger]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
</script>
{% endblock %}