{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Dashboard - ClinTrack{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-fade: rgba(0, 51, 196, 0.08);
    --warning-fade: rgba(255, 87, 48, 0.08);
    --info-fade: rgba(0, 207, 244, 0.08);
    --success-fade: rgba(0, 210, 132, 0.08);
    --danger-fade: rgba(255, 8, 84, 0.08);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

/* Card Enhancements */
.card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.card-title {
    color: #2a2a2a;
    font-weight: 600;
    font-size: 1.1rem;
}

/* Page Header */
.page-header {
    background: linear-gradient(135deg, var(--bs-primary) 0%, #0029a3 100%);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

.page-header h3 {
    color: white;
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.header-left .btn {
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-weight: 500;
    font-size: 0.8125rem;
}

.header-right .btn {
    border-radius: 6px;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.8125rem;
}

.header-right .btn:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* Stat Cards */
.card-stat {
    background: linear-gradient(135deg, var(--bs-primary) 0%, #0029a3 100%);
    border-radius: 8px;
    border: none;
    color: white;
    padding: 1.5rem;
}

.card-stat h3 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.card-stat .badge {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    padding: 0.25rem 0.75rem;
    font-weight: 500;
    font-size: 0.75rem;
}

/* Gradient Backgrounds */
.card-img {
    background: linear-gradient(135deg, var(--bs-primary) 0%, #0029a3 100%);
    border-radius: 8px;
    border: none;
    color: white;
    padding: 1.5rem;
    min-height: 200px;
    display: flex;
    align-items: center;
}

.card-img h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.card-img .btn {
    border-radius: 6px;
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    margin-top: 1rem;
    background: white;
    color: var(--bs-primary);
    transition: all 0.3s ease;
}

.card-img .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Table Styling */
.custom-table {
    margin-bottom: 0;
    font-size: 0.8125rem;
}

.custom-table thead th {
    border: none;
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    padding: 0.75rem 1rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.custom-table tbody td {
    padding: 0.75rem 1rem;
    vertical-align: middle;
    border-bottom: 1px solid #f0f0f0;
}

.custom-table tbody tr:hover {
    background-color: rgba(0, 51, 196, 0.03);
}

.custom-table a {
    color: var(--bs-primary);
    font-weight: 500;
    text-decoration: none;
}

.custom-table a:hover {
    color: #0029a3;
}

/* Badge Styling */
.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.75rem;
}

.badge-success {
    background: rgba(0, 210, 132, 0.1);
    color: var(--bs-success);
    border: 1px solid rgba(0, 210, 132, 0.2);
}

.badge-warning {
    background: rgba(255, 87, 48, 0.1);
    color: var(--bs-warning);
    border: 1px solid rgba(255, 87, 48, 0.2);
}

.badge-info {
    background: rgba(0, 207, 244, 0.1);
    color: var(--bs-info);
    border: 1px solid rgba(0, 207, 244, 0.2);
}

.badge-danger {
    background: rgba(255, 8, 84, 0.1);
    color: var(--bs-danger);
    border: 1px solid rgba(255, 8, 84, 0.2);
}

.badge-secondary {
    background: rgba(160, 160, 160, 0.1);
    color: var(--bs-secondary);
    border: 1px solid rgba(160, 160, 160, 0.2);
}

/* Color Cards */
.color-card {
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: transform 0.2s ease;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.color-card:hover {
    transform: translateY(-3px);
}

.color-card i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.color-card p {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.color-card span {
    font-size: 0.75rem;
    opacity: 0.9;
}

/* Hexagon Stats */
.hexagon {
    width: 40px;
    height: 40px;
    position: relative;
    background: transparent;
    flex-shrink: 0;
}

.hex-mid {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.hexagon-warning { background: linear-gradient(135deg, var(--bs-warning) 0%, #e63e00 100%); }
.hexagon-danger { background: linear-gradient(135deg, var(--bs-danger) 0%, #cc0040 100%); }
.hexagon-success { background: linear-gradient(135deg, var(--bs-success) 0%, #00a868 100%); }
.hexagon-info { background: linear-gradient(135deg, var(--bs-info) 0%, #00a0c4 100%); }
.hexagon-primary { background: linear-gradient(135deg, var(--bs-primary) 0%, #0029a3 100%); }

/* Study Breakdown */
.study-breakdown-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.study-breakdown-item:last-child {
    border-bottom: none;
}

.study-progress {
    height: 6px;
    background: #f0f0f0;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.study-progress-bar {
    height: 100%;
    background: var(--bs-primary);
    border-radius: 3px;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .header-left, .header-right {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .card-stat h3 {
        font-size: 1.5rem;
    }
    
    .card-img h1 {
        font-size: 1.25rem;
    }
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
}

.quick-action-btn {
    background: white;
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.quick-action-btn:hover {
    border-color: var(--bs-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.quick-action-btn i {
    font-size: 1.25rem;
    color: var(--bs-primary);
    margin-bottom: 0.5rem;
    display: block;
}

.quick-action-btn span {
    font-size: 0.75rem;
    font-weight: 500;
    color: #495057;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="page-header">
    <div>
      <h3>Research Staff Dashboard</h3>
      <p style="font-size: 0.875rem; opacity: 0.9; margin: 0.25rem 0 0 0;">Welcome, {{ request.user.get_full_name|default:request.user.username }}</p>
    </div>
    <div class="header-right">
      <button class="btn btn-outline-light" onclick="location.href='{% url 'participant_create' %}'">
        <i class="bi bi-person-plus"></i>
        New Participant
      </button>
      {% if request.user.role != 'viewer' %}
      <button class="btn btn-outline-light" onclick="location.href='#'">
        <i class="bi bi-clipboard2-pulse"></i>
        Report SUSAR
      </button>
      {% endif %}
    </div>
  </div>

  <!-- MY METRICS Row -->
  <div class="row">
    <div class="col-xl-3 stretch-card grid-margin">
      <div class="card card-stat">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h3>{{ my_participants }}</h3>
              <h6>My Participants</h6>
              <div class="badge">Last 7 days: {{ my_recent_participants }}</div>
            </div>
            <div class="hexagon">
              <div class="hex-mid hexagon-primary">
                <i class="bi bi-people"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 stretch-card grid-margin">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Today's Activities</h6>
            <h3 class="mb-0">{{ participants_today }}</h3>
            <small class="text-muted">New Participants</small>
          </div>
          <div class="text-success">
            <i class="bi bi-calendar-check" style="font-size: 2rem;"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 stretch-card grid-margin">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">SUSARs Today</h6>
            <h3 class="mb-0">{{ susars_today }}</h3>
            <small class="text-muted">Adverse Events</small>
          </div>
          <div class="text-danger">
            <i class="bi bi-clipboard2-pulse" style="font-size: 2rem;"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 stretch-card grid-margin">
      <div class="card card-img">
        <div class="card-body d-flex align-items-center">
          <div class="text-white">
            <h1>ClinTrack</h1>
            <p style="font-size: 0.875rem;">{{ user_role }}</p>
            <button class="btn" onclick="location.href='{% url 'participant_list' %}'">
              <i class="bi bi-list-ul"></i>
              View All
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUICK STATS Row -->
  <div class="row">
    <div class="col-md-8 grid-margin">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">System Overview</h5>
          <div class="row">
            <div class="col-md-4">
              <div class="d-flex align-items-center mb-3">
                <div class="hexagon me-3">
                  <div class="hex-mid hexagon-success">
                    <i class="bi bi-check-circle"></i>
                  </div>
                </div>
                <div>
                  <h4 class="mb-0">{{ total_active }}</h4>
                  <small class="text-muted">Active Participants</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center mb-3">
                <div class="hexagon me-3">
                  <div class="hex-mid hexagon-warning">
                    <i class="bi bi-search"></i>
                  </div>
                </div>
                <div>
                  <h4 class="mb-0">{{ total_screening }}</h4>
                  <small class="text-muted">In Screening</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center mb-3">
                <div class="hexagon me-3">
                  <div class="hex-mid hexagon-danger">
                    <i class="bi bi-arrow-clockwise"></i>
                  </div>
                </div>
                <div>
                  <h4 class="mb-0">{{ pending_followups }}</h4>
                  <small class="text-muted">Pending Follow-ups</small>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Study Breakdown -->
          <div class="mt-4">
            <h6 class="mb-3">Study Distribution</h6>
            {% for study in study_stats %}
            <div class="study-breakdown-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ study.name }}</strong>
                  <small class="text-muted d-block">{{ study.code }}</small>
                </div>
                <div class="text-end">
                  <strong>{{ study.total }}</strong>
                  <div class="text-muted" style="font-size: 0.75rem;">
                    {{ study.active }} active
                  </div>
                </div>
              </div>
              <div class="study-progress">
                <div class="study-progress-bar" style="width: {% widthratio study.active study.total 100 %}%"></div>
              </div>
            </div>
            {% empty %}
            <p class="text-muted text-center py-3">No studies available</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 grid-margin">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Quick Actions</h5>
          <div class="quick-actions">
            <div class="quick-action-btn" onclick="location.href='{% url 'participant_create' %}'">
              <i class="bi bi-person-plus"></i>
              <span>Add Participant</span>
            </div>
            <div class="quick-action-btn" onclick="location.href='#'">
              <i class="bi bi-clipboard2-pulse"></i>
              <span>Report SUSAR</span>
            </div>
            <div class="quick-action-btn" onclick="location.href='{% url 'participant_list' %}?status=screening'">
              <i class="bi bi-search"></i>
              <span>View Screening</span>
            </div>
            <div class="quick-action-btn" onclick="location.href='{% url 'susars_list' %}?follow_up_required=true'">
              <i class="bi bi-arrow-clockwise"></i>
              <span>Follow-ups</span>
            </div>
          </div>
          
          <!-- Color Cards -->
          <div class="row mt-4">
            <div class="col-6 mb-3">
              <div class="color-card" style="background: rgba(0, 51, 196, 0.1);">
                <i class="bi bi-people" style="color: var(--bs-primary);"></i>
                <p>My Participants</p>
                <span>{{ my_participants }}</span>
              </div>
            </div>
            <div class="col-6 mb-3">
              <div class="color-card" style="background: rgba(0, 210, 132, 0.1);">
                <i class="bi bi-check-circle" style="color: var(--bs-success);"></i>
                <p>Active</p>
                <span>{{ total_active }}</span>
              </div>
            </div>
            <div class="col-6">
              <div class="color-card" style="background: rgba(255, 87, 48, 0.1);">
                <i class="bi bi-search" style="color: var(--bs-warning);"></i>
                <p>Screening</p>
                <span>{{ total_screening }}</span>
              </div>
            </div>
            <div class="col-6">
              <div class="color-card" style="background: rgba(255, 8, 84, 0.1);">
                <i class="bi bi-arrow-clockwise" style="color: var(--bs-danger);"></i>
                <p>Follow-ups</p>
                <span>{{ pending_followups }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RECENT ACTIVITIES Row -->
  <div class="row">
    <div class="col-lg-6 grid-margin">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">My Recent Participants</h5>
            <a href="{% url 'participant_list' %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-arrow-right"></i>
              View All
            </a>
          </div>
          
          <div class="table-responsive">
            <table class="table custom-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Study</th>
                  <th>Status</th>
                  <th>Enrolled</th>
                </tr>
              </thead>
              <tbody>
                {% for participant in my_recent_list %}
                <tr>
                  <td>
                    <a href="{% url 'participant_detail' participant.id %}">{{ participant.participant_id }}</a>
                  </td>
                  <td>{{ participant.get_full_name }}</td>
                  <td>{{ participant.study.code }}</td>
                  <td>
                    {% if participant.status == 'active' %}
                    <span class="badge badge-success">Active</span>
                    {% elif participant.status == 'screening' %}
                    <span class="badge badge-warning">Screening</span>
                    {% elif participant.status == 'completed' %}
                    <span class="badge badge-info">Completed</span>
                    {% elif participant.status == 'withdrawn' %}
                    <span class="badge badge-secondary">Withdrawn</span>
                    {% elif participant.status == 'lost' %}
                    <span class="badge badge-danger">Lost</span>
                    {% endif %}
                  </td>
                  <td>{{ participant.created_at|date:"M d" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center py-3 text-muted">
                    No participants created yet
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-6 grid-margin">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Recent System Activities</h5>
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="toggleActivityView('participants')">
                Participants
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleActivityView('susars')">
                SUSARs
              </button>
            </div>
          </div>
          
          <!-- Participants Activity -->
          <div id="participantsActivity" class="activity-section">
            {% for participant in recent_participants %}
            <div class="d-flex align-items-start mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
              <div class="me-3">
                <div class="avatar avatar-sm" style="background: rgba(0, 51, 196, 0.1); color: var(--bs-primary); width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-person"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <strong>
                    <a href="{% url 'participant_detail' participant.id %}">{{ participant.get_full_name }}</a>
                  </strong>
                  <small class="text-muted">{{ participant.created_at|timesince }} ago</small>
                </div>
                <small class="text-muted">
                  {{ participant.study.code }} • 
                  {% if participant.created_by %}
                  Added by {{ participant.created_by.get_full_name|default:participant.created_by.username }}
                  {% endif %}
                </small>
              </div>
            </div>
            {% empty %}
            <p class="text-muted text-center py-3">No recent participant activities</p>
            {% endfor %}
          </div>
          
          <!-- SUSARs Activity (hidden by default) -->
          <div id="susarsActivity" class="activity-section" style="display: none;">
            {% for susar in recent_susars %}
            <div class="d-flex align-items-start mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
              <div class="me-3">
                <div class="avatar avatar-sm" style="background: rgba(255, 8, 84, 0.1); color: var(--bs-danger); width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-clipboard2-pulse"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <strong>
                    <a href="{% url 'susars_detail' susar.id %}">{{ susar.susar_id }}</a>
                  </strong>
                  <small class="text-muted">{{ susar.created_at|timesince }} ago</small>
                </div>
                <small class="text-muted">
                  {{ susar.participant.participant_id }} • 
                  Severity: {{ susar.get_severity_display }} • 
                  {% if susar.reported_by %}
                  Reported by {{ susar.reported_by.get_full_name|default:susar.reported_by.username }}
                  {% endif %}
                </small>
              </div>
            </div>
            {% empty %}
            <p class="text-muted text-center py-3">No recent SUSAR activities</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
function toggleActivityView(view) {
    const participantsBtn = document.querySelector('button[onclick*="participants"]');
    const susarsBtn = document.querySelector('button[onclick*="susars"]');
    const participantsSection = document.getElementById('participantsActivity');
    const susarsSection = document.getElementById('susarsActivity');
    
    if (view === 'participants') {
        participantsBtn.classList.add('active');
        susarsBtn.classList.remove('active');
        participantsSection.style.display = 'block';
        susarsSection.style.display = 'none';
    } else {
        participantsBtn.classList.remove('active');
        susarsBtn.classList.add('active');
        participantsSection.style.display = 'none';
        susarsSection.style.display = 'block';
    }
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(tooltipTriggerEl => {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Auto-refresh dashboard every 2 minutes
setTimeout(() => {
    if (document.hasFocus()) {
        window.location.reload();
    }
}, 120000);
</script>
{% endblock %}